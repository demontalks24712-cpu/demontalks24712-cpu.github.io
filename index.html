<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calculator</title>
  
  <!-- React & ReactDOM -->
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <style>
    body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAqzixsAPq3_raCrISBh8DO8hlg_caobRg",
      authDomain: "calc1808-77d23.firebaseapp.com",
      databaseURL: "https://calc1808-77d23-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "calc1808-77d23",
      storageBucket: "calc1808-77d23.firebasestorage.app",
      messagingSenderId: "583746114466",
      appId: "1:583746114466:web:19379c33bae85986de58fb"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const messagesRef = db.ref("messages");

    // Icons
    const Send = () => (
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <line x1="22" y1="2" x2="11" y2="13"></line>
        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
      </svg>
    );

    const ArrowLeft = () => (
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <line x1="19" y1="12" x2="5" y2="12"></line>
        <polyline points="12 19 5 12 12 5"></polyline>
      </svg>
    );

    const User = () => (
      <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
        <circle cx="12" cy="7" r="4"></circle>
      </svg>
    );

    const SecretCalculatorChat = () => {
      const [mode, setMode] = useState('calculator');
      const [display, setDisplay] = useState('0');
      const [secretCode, setSecretCode] = useState('');
      const [messages, setMessages] = useState([]);
      const [newMessage, setNewMessage] = useState('');
      const [username, setUsername] = useState('');
      const [showUsernamePrompt, setShowUsernamePrompt] = useState(false);
      const [loading, setLoading] = useState(false);
      const messagesEndRef = useRef(null);

      const SECRET_CODE = '17071808';

      useEffect(() => {
        const stored = localStorage.getItem('calcChatUsername');
        if (stored) setUsername(stored);
      }, []);

      useEffect(() => {
        if (mode === 'chat') {
          loadMessages();
        }
      }, [mode]);

      useEffect(() => {
        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
      }, [messages]);

      const loadMessages = () => {
        messagesRef.off();
        messagesRef.limitToLast(100).on("value", (snapshot) => {
          const data = snapshot.val();
          if (!data) {
            setMessages([]);
            return;
          }
          const msgs = Object.values(data).sort((a, b) => a.id - b.id);
          setMessages(msgs);
        });
      };

      const handleNumberClick = (num) => {
        if (display === '0') {
          setDisplay(num);
          setSecretCode(num);
        } else {
          setDisplay(display + num);
          setSecretCode(secretCode + num);
        }
      };

      const handleOperator = (op) => {
        setDisplay(display + ' ' + op + ' ');
        setSecretCode('');
      };

      const handleEquals = () => {
        if (secretCode === SECRET_CODE) {
          if (!username) {
            setShowUsernamePrompt(true);
          } else {
            setMode('chat');
            setDisplay('0');
            setSecretCode('');
          }
        } else {
          try {
            const result = eval(display.replace(/×/g, '*').replace(/÷/g, '/'));
            setDisplay(String(result));
            setSecretCode('');
          } catch (e) {
            setDisplay('Error');
            setSecretCode('');
          }
        }
      };

      const handleClear = () => {
        setDisplay('0');
        setSecretCode('');
      };

      const handleUsernameSubmit = () => {
        if (username.trim()) {
          localStorage.setItem('calcChatUsername', username.trim());
          setShowUsernamePrompt(false);
          setMode('chat');
          setDisplay('0');
          setSecretCode('');
        }
      };

      const handleSendMessage = () => {
        if (!newMessage.trim() || !username) return;

        const msg = {
          id: Date.now(),
          user: username,
          text: newMessage.trim(),
          timestamp: Date.now()
        };

        setNewMessage("");
        messagesRef.push(msg);
      };

      const handleBack = () => {
        setMode('calculator');
      };

      const CalcButton = ({ label, onClick, className = '' }) => (
        <button
          onClick={onClick}
          className={`h-16 text-xl font-semibold rounded-lg transition-all active:scale-95 ${className}`}
        >
          {label}
        </button>
      );

      if (showUsernamePrompt) {
        return (
          <div className="flex items-center justify-center min-h-screen bg-gradient-to-br from-gray-100 to-gray-200 p-4">
            <div className="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md">
              <div className="flex items-center justify-center mb-6">
                <User />
              </div>
              <h2 className="text-2xl font-bold text-center mb-2">Welcome</h2>
              <p className="text-gray-600 text-center mb-6">Enter your username to continue</p>
              <input
                type="text"
                value={username}
                onChange={(e) => setUsername(e.target.value)}
                onKeyPress={(e) => e.key === 'Enter' && handleUsernameSubmit()}
                placeholder="Username"
                className="w-full px-4 py-3 border border-gray-300 rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500"
                autoFocus
              />
              <button
                onClick={handleUsernameSubmit}
                className="w-full bg-blue-500 text-white py-3 rounded-lg font-semibold hover:bg-blue-600 transition-colors"
              >
                Continue
              </button>
            </div>
          </div>
        );
      }

      if (mode === 'calculator') {
        return (
          <div className="flex items-center justify-center min-h-screen bg-gradient-to-br from-gray-100 to-gray-200 p-4">
            <div className="bg-white rounded-3xl shadow-2xl p-6 w-full max-w-sm">
              <div className="bg-gray-50 rounded-xl p-6 mb-6 min-h-[100px] flex items-end justify-end">
                <div className="text-4xl font-light text-gray-800 break-all text-right">{display}</div>
              </div>

              <div className="grid grid-cols-4 gap-3">
                <CalcButton label="C" onClick={handleClear} className="bg-gray-200 hover:bg-gray-300 text-gray-700" />
                <CalcButton label="÷" onClick={() => handleOperator('÷')} className="bg-gray-200 hover:bg-gray-300 text-gray-700" />
                <CalcButton label="×" onClick={() => handleOperator('×')} className="bg-gray-200 hover:bg-gray-300 text-gray-700" />
                <CalcButton label="⌫" onClick={() => setDisplay(display.slice(0, -1) || '0')} className="bg-gray-200 hover:bg-gray-300 text-gray-700" />

                <CalcButton label="7" onClick={() => handleNumberClick('7')} className="bg-white hover:bg-gray-50 text-gray-800 border border-gray-200" />
                <CalcButton label="8" onClick={() => handleNumberClick('8')} className="bg-white hover:bg-gray-50 text-gray-800 border border-gray-200" />
                <CalcButton label="9" onClick={() => handleNumberClick('9')} className="bg-white hover:bg-gray-50 text-gray-800 border border-gray-200" />
                <CalcButton label="-" onClick={() => handleOperator('-')} className="bg-gray-200 hover:bg-gray-300 text-gray-700" />

                <CalcButton label="4" onClick={() => handleNumberClick('4')} className="bg-white hover:bg-gray-50 text-gray-800 border border-gray-200" />
                <CalcButton label="5" onClick={() => handleNumberClick('5')} className="bg-white hover:bg-gray-50 text-gray-800 border border-gray-200" />
                <CalcButton label="6" onClick={() => handleNumberClick('6')} className="bg-white hover:bg-gray-50 text-gray-800 border border-gray-200" />
                <CalcButton label="+" onClick={() => handleOperator('+')} className="bg-gray-200 hover:bg-gray-300 text-gray-700" />

                <CalcButton label="1" onClick={() => handleNumberClick('1')} className="bg-white hover:bg-gray-50 text-gray-800 border border-gray-200" />
                <CalcButton label="2" onClick={() => handleNumberClick('2')} className="bg-white hover:bg-gray-50 text-gray-800 border border-gray-200" />
                <CalcButton label="3" onClick={() => handleNumberClick('3')} className="bg-white hover:bg-gray-50 text-gray-800 border border-gray-200" />
                <CalcButton label="=" onClick={handleEquals} className="bg-blue-500 hover:bg-blue-600 text-white row-span-2" />

                <CalcButton label="0" onClick={() => handleNumberClick('0')} className="col-span-2 bg-white hover:bg-gray-50 text-gray-800 border border-gray-200" />
                <CalcButton label="." onClick={() => handleNumberClick('.')} className="bg-white hover:bg-gray-50 text-gray-800 border border-gray-200" />
              </div>
            </div>
          </div>
        );
      }

      return (
        <div className="flex flex-col h-screen bg-gray-50">
          <div className="bg-blue-500 text-white p-4 flex items-center shadow-md">
            <button onClick={handleBack} className="mr-3 hover:bg-blue-600 p-2 rounded-full transition-colors">
              <ArrowLeft />
            </button>
            <h1 className="text-xl font-semibold">Secure Chat</h1>
            <div className="ml-auto text-sm bg-blue-600 px-3 py-1 rounded-full">{username}</div>
          </div>

          <div className="flex-1 overflow-y-auto p-4 space-y-3">
            {messages.length === 0 ? (
              <div className="flex items-center justify-center h-full text-gray-400">
                <p>No messages yet. Start the conversation!</p>
              </div>
            ) : (
              messages.map((msg) => {
                const isOwn = msg.user === username;
                return (
                  <div key={msg.id} className={`flex ${isOwn ? 'justify-end' : 'justify-start'}`}>
                    <div className={`max-w-[70%] ${isOwn ? 'bg-blue-500 text-white' : 'bg-white text-gray-800'} rounded-2xl px-4 py-2 shadow`}>
                      {!isOwn && <div className="text-xs font-semibold mb-1 opacity-70">{msg.user}</div>}
                      <div className="break-words">{msg.text}</div>
                      <div className={`text-xs mt-1 ${isOwn ? 'text-blue-100' : 'text-gray-500'}`}>
                        {new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                      </div>
                    </div>
                  </div>
                );
              })
            )}
            <div ref={messagesEndRef} />
          </div>

          <div className="bg-white border-t border-gray-200 p-4">
            <div className="flex items-center space-x-2">
              <input
                type="text"
                value={newMessage}
                onChange={(e) => setNewMessage(e.target.value)}
                onKeyPress={(e) => e.key === 'Enter' && handleSendMessage()}
                placeholder="Type a message..."
                className="flex-1 px-4 py-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
              <button
                onClick={handleSendMessage}
                className="bg-blue-500 text-white p-3 rounded-full hover:bg-blue-600 transition-colors active:scale-95"
              >
                <Send />
              </button>
            </div>
          </div>
        </div>
      );
    };

    ReactDOM.render(<SecretCalculatorChat />, document.getElementById('root'));
  </script>
</body>
</html>
