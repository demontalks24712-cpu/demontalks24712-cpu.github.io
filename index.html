<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Calculator</title>

  <!-- React -->
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <style>
    body { margin: 0; font-family: system-ui; }
  </style>
</head>

<body>
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect, useRef } = React;

/* Firebase Config */
firebase.initializeApp({
  apiKey: "AIzaSyAqzixsAPq3_raCrISBh8DO8hlg_caobRg",
  authDomain: "calc1808-77d23.firebaseapp.com",
  databaseURL: "https://calc1808-77d23-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "calc1808-77d23",
  storageBucket: "calc1808-77d23.firebasestorage.app",
  messagingSenderId: "583746114466",
  appId: "1:583746114466:web:19379c33bae85986de58fb"
});

const db = firebase.database();
const messagesRef = db.ref("messages");

/* Icons */
const Send = () => (
  <svg width="20" height="20" fill="none" stroke="currentColor" strokeWidth="2">
    <line x1="22" y1="2" x2="11" y2="13"/>
    <polygon points="22 2 15 22 11 13 2 9 22 2"/>
  </svg>
);

const ArrowLeft = () => (
  <svg width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2">
    <line x1="19" y1="12" x2="5" y2="12"/>
    <polyline points="12 19 5 12 12 5"/>
  </svg>
);

const User = () => (
  <svg width="48" height="48" fill="none" stroke="currentColor" strokeWidth="2">
    <circle cx="12" cy="7" r="4"/>
    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
  </svg>
);

function SecretCalculatorChat() {
  const [mode, setMode] = useState("calculator");
  const [display, setDisplay] = useState("0");
  const [secretCode, setSecretCode] = useState("");
  const [messages, setMessages] = useState([]);
  const [newMessage, setNewMessage] = useState("");
  const [username, setUsername] = useState("");
  const [showUsernamePrompt, setShowUsernamePrompt] = useState(false);
  const messagesEndRef = useRef(null);

  const SECRET_CODE = "17071808";
  const CLEAR_CHAT_CODE = "18082009";

  useEffect(() => {
    const stored = localStorage.getItem("calcChatUsername");
    if (stored) setUsername(stored);
  }, []);

  useEffect(() => {
    if (mode === "chat") {
      messagesRef.off();
      messagesRef.limitToLast(100).on("value", snap => {
        const data = snap.val() || {};
        setMessages(Object.values(data));
      });
    }
  }, [mode]);

  useEffect(() => {
    messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
  }, [messages]);

  const handleEquals = () => {
    if (secretCode === SECRET_CODE) {
      if (!username) setShowUsernamePrompt(true);
      else setMode("chat");
      setDisplay("0");
      setSecretCode("");
      return;
    }
    try {
      setDisplay(String(eval(display.replace("ร","*").replace("รท","/"))));
      setSecretCode("");
    } catch {
      setDisplay("Error");
    }
  };

  const handleClearChat = () => {
    const code = prompt("Enter passcode to clear all chats:");
    if (code === CLEAR_CHAT_CODE) {
      messagesRef.remove();
      alert("Chats cleared");
    } else if (code) {
      alert("Incorrect passcode");
    }
  };

  const handleSend = () => {
    if (!newMessage.trim()) return;
    messagesRef.push({
      id: Date.now(),
      user: username,
      text: newMessage,
      timestamp: Date.now()
    });
    setNewMessage("");
  };

  if (showUsernamePrompt) {
    return (
      <div className="h-screen flex items-center justify-center bg-gray-100">
        <div className="bg-white p-6 rounded-xl shadow w-80">
          <User className="mx-auto"/>
          <input
            className="w-full mt-4 border p-2 rounded"
            placeholder="Username"
            value={username}
            onChange={e => setUsername(e.target.value)}
          />
          <button
            className="w-full mt-4 bg-blue-500 text-white p-2 rounded"
            onClick={() => {
              localStorage.setItem("calcChatUsername", username);
              setShowUsernamePrompt(false);
              setMode("chat");
            }}
          >
            Continue
          </button>
        </div>
      </div>
    );
  }

  if (mode === "calculator") {
    return (
      <div className="h-screen flex items-center justify-center bg-gray-100">
        <div className="bg-white p-6 rounded-xl w-80">
          <div className="text-right text-3xl mb-4">{display}</div>
          <button className="w-full bg-blue-500 text-white p-3 rounded"
            onClick={() => {
              setSecretCode("17071808");
              handleEquals();
            }}>
            =
          </button>
        </div>
      </div>
    );
  }

  return (
    <div className="flex flex-col h-screen">
      <div className="bg-blue-500 text-white p-4 flex items-center">
        <button onClick={() => setMode("calculator")} className="mr-2">
          <ArrowLeft/>
        </button>
        <h1 className="font-semibold">Secure Chat</h1>
        <button
          onClick={handleClearChat}
          className="ml-auto mr-3 bg-red-500 px-3 py-1 rounded"
        >
          Clear
        </button>
        <span className="bg-blue-600 px-3 py-1 rounded">{username}</span>
      </div>

      <div className="flex-1 overflow-y-auto p-4">
        {messages.map(m => (
          <div key={m.id} className="mb-2">
            <b>{m.user}:</b> {m.text}
          </div>
        ))}
        <div ref={messagesEndRef}/>
      </div>

      <div className="p-3 border-t flex">
        <input
          className="flex-1 border rounded px-3"
          value={newMessage}
          onChange={e => setNewMessage(e.target.value)}
          onKeyDown={e => e.key === "Enter" && handleSend()}
        />
        <button onClick={handleSend} className="ml-2 bg-blue-500 text-white p-3 rounded">
          <Send/>
        </button>
      </div>
    </div>
  );
}

ReactDOM.render(<SecretCalculatorChat />, document.getElementById("root"));
</script>
</body>
</html>
