<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Secure Messenger</title>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <style>
    body { margin: 0; background: #000; color: white; font-family: -apple-system, sans-serif; }
    .calc-btn { height: 60px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; transition: all 0.1s; cursor: pointer; }
    .calc-btn:active { transform: scale(0.92); filter: brightness(1.3); }
    .whatsapp-bg { background-color: #efeae2; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); }
    .glass { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(20px); }
  </style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect, useRef } = React;

const firebaseConfig = {
  apiKey: "AIzaSyAqzixsAPq3_raCrISBh8DO8hlg_caobRg",
  authDomain: "calc1808-77d23.firebaseapp.com",
  databaseURL: "https://calc1808-77d23-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "calc1808-77d23",
  storageBucket: "calc1808-77d23.firebasestorage.app",
  messagingSenderId: "583746114466",
  appId: "1:583746114466:web:19379c33bae85986de58fb"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const App = () => {
  const [view, setView] = useState('calculator'); // calculator, auth, contacts, chat
  const [display, setDisplay] = useState('0');
  const [currentUser, setCurrentUser] = useState(null);
  const [users, setUsers] = useState([]);
  const [activeChat, setActiveChat] = useState({ id: 'global', name: 'Global Group' });
  const [messages, setMessages] = useState([]);
  const [msgInput, setMsgInput] = useState('');
  const [authForm, setAuthForm] = useState({ user: '', pass: '', isSignup: true });
  const messagesEndRef = useRef(null);

  const SECRET_CODE = '17071808';

  // Persistence & User Loading
  useEffect(() => {
    const saved = localStorage.getItem('calc_user');
    if (saved) setCurrentUser(JSON.parse(saved));
    
    db.ref('users').on('value', s => {
      const data = s.val() ? Object.keys(s.val()) : [];
      setUsers(data);
    });
  }, []);

  // Message Listener
  useEffect(() => {
    if (view === 'chat') {
      const chatRef = db.ref(`chats/${activeChat.id}`);
      chatRef.on('value', s => setMessages(s.val() ? Object.values(s.val()) : []));
      return () => chatRef.off();
    }
  }, [view, activeChat]);

  useEffect(() => { messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [messages]);

  const handleCalc = (val) => {
    if (val === 'AC') return setDisplay('0');
    if (val === '=') {
      if (display === SECRET_CODE) setView(currentUser ? 'contacts' : 'auth');
      else {
        try { setDisplay(String(eval(display.replace(/×/g,'*').replace(/÷/g,'/')))); } 
        catch { setDisplay('Error'); }
      }
      return;
    }
    setDisplay(p => p === '0' ? val : p + val);
  };

  const handleAuth = () => {
    if (!authForm.user || !authForm.pass) return alert("Missing fields");
    const uRef = db.ref(`users/${authForm.user}`);
    if (authForm.isSignup) {
      uRef.set({ pass: authForm.pass });
      login(authForm.user);
    } else {
      uRef.once('value', s => {
        if (s.val()?.pass === authForm.pass) login(authForm.user);
        else alert("Invalid credentials");
      });
    }
  };

  const login = (name) => {
    const user = { name };
    setCurrentUser(user);
    localStorage.setItem('calc_user', JSON.stringify(user));
    setView('contacts');
  };

  const startPrivateChat = (otherUser) => {
    const id = [currentUser.name, otherUser].sort().join('_');
    setActiveChat({ id, name: otherUser, isPrivate: true });
    setView('chat');
  };

  const sendMessage = () => {
    if (!msgInput.trim()) return;
    db.ref(`chats/${activeChat.id}`).push({
      sender: currentUser.name,
      text: msgInput,
      time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
    });
    setMsgInput('');
  };

  // --- RENDERING ---

  if (view === 'calculator') return (
    <div className="flex flex-col h-screen p-6 max-w-md mx-auto bg-black">
      <div className="flex-1 flex items-end justify-end text-6xl font-light mb-8">{display}</div>
      <div className="grid grid-cols-4 gap-3">
        {['AC','(',')','÷','7','8','9','×','4','5','6','-','1','2','3','+'].map(b => (
          <button key={b} onClick={()=>handleCalc(b)} className={`calc-btn ${isNaN(b)?'bg-zinc-400 text-black':'bg-zinc-800'}`}>{b}</button>
        ))}
        <button onClick={()=>handleCalc('0')} className="calc-btn bg-zinc-800 col-span-2">0</button>
        <button onClick={()=>handleCalc('.')} className="calc-btn bg-zinc-800">.</button>
        <button onClick={()=>handleCalc('=')} className="calc-btn bg-orange-500">=</button>
      </div>
    </div>
  );

  if (view === 'auth') return (
    <div className="h-screen flex items-center justify-center p-8">
      <div className="glass w-full p-8 rounded-3xl border border-white/20">
        <h2 className="text-2xl font-bold mb-6">{authForm.isSignup ? 'Create Profile' : 'Login'}</h2>
        <input className="w-full bg-white/10 p-4 rounded-xl mb-4" placeholder="Username" onChange={e=>setAuthForm({...authForm, user: e.target.value})} />
        <input type="password" className="w-full bg-white/10 p-4 rounded-xl mb-6" placeholder="Password" onChange={e=>setAuthForm({...authForm, pass: e.target.value})} />
        <button onClick={handleAuth} className="w-full bg-green-600 p-4 rounded-xl font-bold">{authForm.isSignup ? 'Sign Up' : 'Login'}</button>
        <button className="w-full mt-4 text-sm opacity-50" onClick={()=>setAuthForm({...authForm, isSignup: !authForm.isSignup})}>
          Switch to {authForm.isSignup ? 'Login' : 'Signup'}
        </button>
      </div>
    </div>
  );

  if (view === 'contacts') return (
    <div className="h-screen flex flex-col bg-zinc-900">
      <div className="p-6 pt-12 bg-zinc-800 flex justify-between items-center">
        <h1 className="text-xl font-bold text-green-500">Chats</h1>
        <button onClick={()=>setView('calculator')} className="text-xs opacity-50">Lock</button>
      </div>
      <div className="flex-1 overflow-y-auto">
        <div onClick={()=> {setActiveChat({id:'global', name:'Global Group'}); setView('chat');}} className="p-4 border-b border-white/5 flex items-center gap-4 cursor-pointer hover:bg-white/5">
          <div className="w-12 h-12 bg-green-600 rounded-full flex items-center justify-center font-bold">G</div>
          <div><p className="font-bold">Global Lounge</p><p className="text-xs text-gray-400">Everyone is here</p></div>
        </div>
        <p className="p-4 text-xs text-gray-500 uppercase tracking-widest font-bold">Contacts</p>
        {users.filter(u => u !== currentUser.name).map(u => (
          <div key={u} onClick={()=>startPrivateChat(u)} className="p-4 border-b border-white/5 flex items-center gap-4 cursor-pointer hover:bg-white/5">
            <div className="w-12 h-12 bg-zinc-700 rounded-full flex items-center justify-center font-bold">{u[0]}</div>
            <p className="font-bold">{u}</p>
          </div>
        ))}
      </div>
    </div>
  );

  if (view === 'chat') return (
    <div className="h-screen flex flex-col whatsapp-bg">
      <div className="p-4 pt-12 bg-[#075e54] flex items-center gap-3 shadow-md">
        <button onClick={()=>setView('contacts')} className="text-2xl">←</button>
        <div className="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center font-bold">{activeChat.name[0]}</div>
        <div className="flex-1">
          <p className="font-bold leading-tight">{activeChat.name}</p>
          <p className="text-[10px] opacity-70">online</p>
        </div>
      </div>
      <div className="flex-1 overflow-y-auto p-4 space-y-2">
        {messages.map((m, i) => (
          <div key={i} className={`flex ${m.sender === currentUser.name ? 'justify-end' : 'justify-start'}`}>
            <div className={`max-w-[85%] px-3 py-1.5 rounded-lg shadow-sm relative ${m.sender === currentUser.name ? 'bg-[#dcf8c6] text-black rounded-tr-none' : 'bg-white text-black rounded-tl-none'}`}>
              {activeChat.id === 'global' && m.sender !== currentUser.name && <p className="text-[10px] font-bold text-blue-600 mb-0.5">{m.sender}</p>}
              <p className="text-sm pb-3 pr-8">{m.text}</p>
              <span className="text-[9px] opacity-50 absolute bottom-1 right-2">{m.time}</span>
            </div>
          </div>
        ))}
        <div ref={messagesEndRef} />
      </div>
      <div className="p-2 bg-[#f0f0f0] flex gap-2 items-center">
        <input className="flex-1 bg-white p-3 rounded-full text-black outline-none shadow-inner" placeholder="Type a message" value={msgInput} onChange={e=>setMsgInput(e.target.value)} onKeyPress={e=>e.key==='Enter'&&sendMessage()} />
        <button onClick={sendMessage} className="bg-[#128c7e] w-12 h-12 rounded-full flex items-center justify-center shadow-lg active:scale-90 transition-transform">
           <svg width="20" height="20" viewBox="0 0 24 24" fill="white"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
        </button>
      </div>
    </div>
  );
};

ReactDOM.render(<App />, document.getElementById('root'));
</script>
</body>
</html>
